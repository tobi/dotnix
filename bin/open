#!/bin/sh

# on osx we just exec its own open, only on linux do we want to emulate its behavior
[[ -x /usr/bin/open ]] && exec /usr/bin/open "$@"

# This script launches applications with intelligent fallback
# Normalize open: always open outside of the tty (if interactive), support launching by full path, $PATH, or .desktop file.
# - If run from a tty (interactive), always background the app (nohup ... &)
# - If run from a GUI (not a tty), exec the app directly
# - If argument is a full path and executable, run it
# - If argument is in $PATH, run it
# - If argument matches a .desktop file, open it with dex

run_app() {
  if [ -t 0 ]; then
    nohup "$1" "${@:2}" > /dev/null 2>&1 &
    disown
    exit 0
  else
    exec "$1" "${@:2}"
  fi
}

if [ -z "$1" ]; then
  echo "Usage: $0 <app-name-or-path>"
  exit 1
fi

APP="$1"
shift

# 1. Full path and executable
if [[ "$APP" == */* && -x "$APP" ]]; then
  run_app "$APP" "$@"
fi

# 2. In $PATH
if command -v "$APP" >/dev/null 2>&1; then
  run_app "$APP" "$@"
fi

# 3. .desktop file (case-insensitive search)
input=$(echo "$APP" | tr '[:upper:]' '[:lower:]')
search_dirs="
  $HOME/.local/state/nix/profiles/home-manager/home-path/share/applications
  $HOME/.nix-profile/share/applications
  /usr/share/applications
"
if [ -n "$XDG_DATA_HOME" ]; then
  search_dirs="$XDG_DATA_HOME/applications $search_dirs"
fi
if [ -n "$XDG_DATA_DIRS" ]; then
  IFS=: read -ra xdg_dirs <<< "$XDG_DATA_DIRS"
  for d in "${xdg_dirs[@]}"; do
    search_dirs="$search_dirs $d/applications"
  done
fi

found=""
for dir in $search_dirs; do
  [ -d "$dir" ] || continue
  for file in "$dir"/*.desktop; do
    [ -e "$file" ] || continue
    filename=$(basename "$file" | tr '[:upper:]' '[:lower:]')
    if [ "$filename" = "$input.desktop" ] || [ "$filename" = "$input" ]; then
      found="$file"
      break 2
    fi
  done
done

if [ -n "$found" ]; then
  if [ -t 0 ]; then
    nohup dex "$found" > /dev/null 2>&1 &
    disown
    exit 0
  else
    exec dex "$found"
  fi
fi

echo "Could not find or launch: $APP"
exit 1


run_app() {
  if [ -t 0 ]; then
    nohup "$1" > /dev/null 2>&1
    exit 0
  else
    exec "$1"
  fi
}

if [ -z "$1" ]; then
  echo "Usage: $0 <app-name-or-path>"
  exit 1
fi

# Priority 1: Exact path (if it contains / and is executable)
if [[ "$1" == */* && -x "$1" ]]; then
  run_app "$1"
fi

# Priority 2: Command in PATH
if command -v "$1" >/dev/null 2>&1; then
  run_app "$1"
fi

# Priority 3: Desktop file fallback
echo "Searching for $1.desktop file..."

# Convert input to lowercase for desktop file search
input=$(echo "$1" | tr '[:upper:]' '[:lower:]')

# Directories to search for .desktop files
search_dirs="
  $HOME/.local/state/nix/profiles/home-manager/home-path/share/applications
  $HOME/.nix-profile/share/applications
  /usr/share/applications
"

search_dirs+=$(IFS=:; for d in $XDG_DATA_HOME:$XDG_DATA_DIRS; do
  [ -n "$d" ] && echo "$d/share/applications"
done)

# Search for the .desktop file
for dir in $search_dirs; do
  for file in "$dir"/*; do
    # Convert filename to lowercase
    filename=$(basename "$file" | tr '[:upper:]' '[:lower:]')
    if [ "$filename" = "$input.desktop" ] || [ "$filename" = "$input" ]; then
      echo "Opening $file"
      dex "$file"
      exit 0
    fi
  done
done

echo "Error: Could not find or execute '$1'"
echo "  - Not found as executable path"
echo "  - Not found in PATH"
echo "  - No $1.desktop file found"
exit 1