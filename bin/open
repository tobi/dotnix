#!/usr/bin/env bash

# On macOS, defer to the native open
[ -x /usr/bin/open ] && exec /usr/bin/open "$@"

# Simplified launcher: run everything in a user scope under apps.slice
# - From a TTY: start in background and return immediately
# - From GUI/non-TTY: exec and let systemd manage the process

desktop-run() {
  # From a TTY, don't block the terminal: run as a transient service and return
  if [ -t 1 ]; then
    systemd-run --same-dir --user --scope --quiet --slice=apps.slice -- $@ &
    disown
    exit 0
  else
    # From non-TTY contexts, replace the process and let systemd keep tracking it
    exec systemd-run --same-dir --user --scope --quiet --slice=apps.slice -- $@
  fi
}

if [ -z "$1" ]; then
  echo "Usage: $0 <command> [args...]"
  exit 1
fi


app=$1
shift

search_dirs=(
  $HOME/Applications
  $HOME/local/share
  /usr/share
)

error() {
  if [ -t 1 ]; then
    echo "error: $1" >&2
  else
    notify-send "error: $1" -u critical -t 3000 -i dialog-error
  fi
  exit 1
}


# Add all $XDG_DATA_DIRS to search_dirs, if set
if [ -n "$XDG_DATA_DIRS" ]; then
  IFS=':' read -ra xdg_dirs <<< "$XDG_DATA_DIRS"
  for dir in "${xdg_dirs[@]}"; do
    search_dirs+=("$dir")
  done
fi


resolve_app() {

  # if its an executable, run it directly
  if [[ -x "$app" && ! -d "$app" ]]; then
    cli=("$app")
    return 0
  fi

  # if its a file or directory, use xdg-open to defer to the default desktop
  if [ -e "$app" ] || [ -d "$app" ]; then
    cli=("xdg-open" "$app")
    return 0
  fi

  # if its a command, in $PATH it directly
  if command -v "$app" >/dev/null 2>&1; then
    cli=("$app")
    return 0
  fi

  # Otherwise search the search_dirs for a .desktop or a .AppImage of matching name
  for dir in "${search_dirs[@]}"; do

    if [ -x "$dir/$app" ]; then
      cli=("$dir/$app")
      return 0
    fi

    if [ -f "$dir/applications/$app.desktop" ]; then
      cli=(dex "$dir/$app.desktop")
      return 0
    fi

    if [ -f "$dir/$app.desktop" ]; then
      cli=(dex "$dir/$app.desktop")
      return 0
    fi

    if [ -f "$dir/$app.AppImage" ]; then
      cli=(appimage-run "$dir/$app.AppImage")
      return 0
    fi
  done

  return 1
}


if ! resolve_app; then
  error "app not found: $app"
fi

cli+=("$@")
desktop-run "${cli[@]}"
