#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Directories
APPLICATIONS_DIR="$HOME/Applications"
ICONS_DIR="$HOME/.local/share/icons"
CHROME_WRAPPER="$HOME/.local/bin/chrome"

usage() {
    echo "Usage: $0 <AppName> --url <URL> [chrome options...]"
    echo
    echo "Create a web app desktop entry with automatic icon fetching"
    echo
    echo "Arguments:"
    echo "  AppName           Name of the application (e.g., Hey, Notion)"
    echo "  --url <URL>       URL of the web application"
    echo "  [chrome options]  Additional Chrome flags to pass through"
    echo
    echo "Examples:"
    echo "  $0 Hey --url https://hey.com"
    echo "  $0 Notion --url https://notion.so --enable-features=SomeFeature"
    exit 1
}

log_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}⚠${NC} $1"
}

log_error() {
    echo -e "${RED}✗${NC} $1"
}

# Parse arguments
if [ $# -lt 3 ]; then
    usage
fi

APP_NAME="$1"
shift

if [ "$1" != "--url" ]; then
    log_error "Expected --url as second argument"
    usage
fi
shift

URL="$1"
shift

# Remaining arguments are Chrome options
CHROME_OPTS=("$@")

# Validate URL
if [[ ! "$URL" =~ ^https?:// ]]; then
    log_error "URL must start with http:// or https://"
    exit 1
fi

# Extract domain from URL
DOMAIN=$(echo "$URL" | sed -E 's|^https?://([^/]+).*|\1|')
log_info "Domain: $DOMAIN"

# Generate lowercase app name for file names
APP_NAME_LOWER=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]')

# Create directories if they don't exist
mkdir -p "$APPLICATIONS_DIR"
mkdir -p "$ICONS_DIR"

# Fetch the website and extract icon URLs
log_info "Fetching $URL to find icons..."
HTML=$(curl -sL "$URL" || true)

# Function to extract icon URL from HTML
find_icon_url() {
    local html="$1"
    local base_url="$2"

    # Try to find various icon meta tags (in order of preference)
    # Using sed instead of grep -P for better compatibility

    # 1. SVG icons
    local icon_url=$(echo "$html" | grep 'rel="icon"' | grep -o 'href="[^"]*\.svg"' | sed 's/href="\([^"]*\)"/\1/' | head -1 || true)

    # 2. Apple touch icons (usually high quality)
    if [ -z "$icon_url" ]; then
        icon_url=$(echo "$html" | grep 'rel="apple-touch-icon"' | grep -o 'href="[^"]*"' | sed 's/href="\([^"]*\)"/\1/' | head -1 || true)
    fi

    # 3. Shortcut icon
    if [ -z "$icon_url" ]; then
        icon_url=$(echo "$html" | grep 'rel="shortcut icon"' | grep -o 'href="[^"]*"' | sed 's/href="\([^"]*\)"/\1/' | head -1 || true)
    fi

    # 4. Regular icon
    if [ -z "$icon_url" ]; then
        icon_url=$(echo "$html" | grep 'rel="icon"' | grep -o 'href="[^"]*"' | sed 's/href="\([^"]*\)"/\1/' | head -1 || true)
    fi

    # 5. Try favicon.ico as fallback
    if [ -z "$icon_url" ]; then
        icon_url="/favicon.ico"
    fi

    # Make URL absolute if it's relative
    if [[ "$icon_url" =~ ^/ ]]; then
        echo "${base_url}${icon_url}"
    elif [[ "$icon_url" =~ ^https?:// ]]; then
        echo "$icon_url"
    else
        echo "${base_url}/${icon_url}"
    fi
}

BASE_URL=$(echo "$URL" | sed -E 's|(https?://[^/]+).*|\1|')
ICON_URL=$(find_icon_url "$HTML" "$BASE_URL")
log_info "Found icon URL: $ICON_URL"

# Determine file extension
if [[ "$ICON_URL" =~ \.svg$ ]]; then
    ICON_EXT="svg"
elif [[ "$ICON_URL" =~ \.png$ ]]; then
    ICON_EXT="png"
elif [[ "$ICON_URL" =~ \.jpg$ ]] || [[ "$ICON_URL" =~ \.jpeg$ ]]; then
    ICON_EXT="jpg"
elif [[ "$ICON_URL" =~ \.ico$ ]]; then
    ICON_EXT="ico"
else
    # Default to png
    ICON_EXT="png"
fi

ICON_FILE="$ICONS_DIR/${APP_NAME_LOWER}.${ICON_EXT}"

# Download the icon
log_info "Downloading icon to $ICON_FILE..."
if curl -sL "$ICON_URL" -o "$ICON_FILE"; then
    # Verify the file is not empty and is a valid image
    if [ -s "$ICON_FILE" ]; then
        log_success "Icon downloaded successfully"
        ICON_PATH="$ICON_FILE"
    else
        log_warn "Downloaded icon is empty, removing"
        rm -f "$ICON_FILE"
        ICON_PATH=""
    fi
else
    log_warn "Failed to download icon"
    ICON_PATH=""
fi

# Build Chrome options string
CHROME_OPTS_STR=""
if [ ${#CHROME_OPTS[@]} -gt 0 ]; then
    for opt in "${CHROME_OPTS[@]}"; do
        CHROME_OPTS_STR="$CHROME_OPTS_STR $opt"
    done
fi

# Create the .desktop file
DESKTOP_FILE="$APPLICATIONS_DIR/${APP_NAME}.desktop"
log_info "Creating desktop entry at $DESKTOP_FILE..."

cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=$APP_NAME
Comment=$APP_NAME Web Application
Exec=$CHROME_WRAPPER --new-window --app=$URL --name=$APP_NAME --class=$APP_NAME${CHROME_OPTS_STR}
Terminal=false
StartupNotify=true
Categories=Network;WebBrowser;
EOF

if [ -n "$ICON_PATH" ]; then
    echo "Icon=$ICON_PATH" >> "$DESKTOP_FILE"
fi

chmod +x "$DESKTOP_FILE"

log_success "Desktop entry created: $DESKTOP_FILE"
if [ -n "$ICON_PATH" ]; then
    log_success "Icon installed: $ICON_PATH"
fi

log_info ""
log_success "Web app '$APP_NAME' is ready! You can now launch it from fuzzel or your application launcher."
