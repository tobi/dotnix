#!/usr/bin/env bash
# switch - Smart switch script for NixOS and home-manager
# Automatically detects environment and runs appropriate command

set -euo pipefail

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Configuration
readonly FLAKE_PATH="${HOME}/dotnix"
readonly USERNAME="${USER:-tobi}"
readonly ARCHITECTURE="${HOSTTYPE:-aarch64}"

# Detect environment
detect_environment() {
    if [ -n "${WSL_DISTRO_NAME:-}" ]; then
        echo "wsl"
    elif [ -f /etc/NIXOS ]; then
        echo "nixos"
    else
        echo "other"
    fi
}

# Show usage
usage() {
    cat << EOF
Usage: switch [OPTIONS]

Smart switch script that automatically detects your environment and runs the appropriate command.

OPTIONS:
    -h, --help          Show this help message
    -v, --verbose       Enable verbose output
    -q, --quiet         Suppress non-error output
    --dry-run          Show what would be done without executing
    --force            Force rebuild even if no changes detected

ENVIRONMENTS:
    nixos              Full NixOS system rebuild
    wsl                WSL2 NixOS rebuild
    other              Home-manager only rebuild

EXAMPLES:
    switch             # Normal switch
    switch --verbose  # Verbose output
    switch --dry-run  # Show what would happen
    switch --force    # Force rebuild

EOF
}

# Parse arguments
VERBOSE=false
QUIET=false
DRY_RUN=false
FORCE=false
FORCE_NIXPKGS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}" >&2
            usage >&2
            exit 1
            ;;
    esac
done

# Logging functions
log_info() {
    if [[ "$QUIET" != "true" ]]; then
        echo -e "${BLUE}â„¹ï¸  $1${NC}"
    fi
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}" >&2
}

# Detect environment
detect_environment() {
    if [ -n "${WSL_DISTRO_NAME:-}" ]; then
        echo "wsl"
    elif [ -f /etc/NIXOS ]; then
        echo "nixos"
    else
        echo "other"
    fi
}

# Main switch function
main() {
    local args=("$@")
    local env_type
    env_type=$(detect_environment)

    # Create temporary log file
    local log_file
    log_file=$(mktemp "${TMPDIR:-/tmp}/dotnix-switch.XXXXXX")

    if [[ "$QUIET" != "true" ]]; then
        echo
        echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "  ${GREEN}ğŸ”„ Switching Configuration${NC}"
        echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "  ${BLUE}Environment:${NC}  ${YELLOW}${env_type}${NC}"
        echo -e "  ${BLUE}User:${NC}         ${YELLOW}${USERNAME}@${ARCHITECTURE}${NC}"
        echo -e "  ${BLUE}Flake:${NC}        ${YELLOW}${FLAKE_PATH}${NC}"
        echo -e "  ${BLUE}Log:${NC}          ${YELLOW}${log_file}${NC}"
        echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo
    fi

    local extras=""
    local nixos_cmd=""
    local home_manager_cmd=""

    # Determine which commands to run based on environment
    case "$env_type" in
        "wsl"|"nixos")
            echo -e "${BLUE}â–¸${NC} Running ${YELLOW}NixOS${NC} system switch..."
            nixos_cmd="sudo nixos-rebuild switch $extras --flake \"${FLAKE_PATH}\""

            echo -e "${BLUE}â–¸${NC} Running ${YELLOW}home-manager${NC} switch..."
            home_manager_cmd="home-manager switch $extras --flake \"${FLAKE_PATH}/modules/home-manager#${USERNAME}@x86_64\""
            ;;
        "other")
            echo -e "${BLUE}â–¸${NC} Running ${YELLOW}home-manager${NC} switch..."
            home_manager_cmd="home-manager switch $extras --flake \"${FLAKE_PATH}/modules/home-manager#${USERNAME}@${ARCHITECTURE}\""
            ;;
        *)
            log_error "Unknown environment type: ${env_type}"
            exit 1
            ;;
    esac

    # Add verbose flag if requested
    if [[ "$VERBOSE" == "true" ]]; then
        nixos_cmd="$nixos_cmd --verbose"
        home_manager_cmd="$home_manager_cmd --verbose"
    fi

    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "Dry run mode - showing what would be executed:"
        if [[ -n "$nixos_cmd" ]]; then
            echo "1. $nixos_cmd"
        fi
        if [[ -n "$home_manager_cmd" ]]; then
            echo "2. $home_manager_cmd"
        fi
        exit 0
    fi

    # Execute NixOS rebuild if applicable
    if [[ -n "$nixos_cmd" ]]; then
        echo -e "${BLUE}â”â”â” ${YELLOW}NixOS System Rebuild${NC} ${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo
        if eval "$nixos_cmd $args 2>&1 | tee -a '$log_file'"; then
            echo
            echo -e "${GREEN}âœ“${NC} NixOS switch ${GREEN}completed successfully${NC}!"
        else
            echo
            echo -e "${RED}âœ—${NC} NixOS switch ${RED}failed${NC}!"
            echo
            echo -e "${YELLOW}To debug:${NC}"
            echo -e "  ${BLUE}â†’${NC} less '$log_file'"
            exit 1
        fi
        echo
    fi

    # Execute home-manager switch
    if [[ -n "$home_manager_cmd" ]]; then
        echo -e "${BLUE}â”â”â” ${YELLOW}Home Manager Configuration${NC} ${BLUE}â”â”â”â”â”â”${NC}"
        echo
        if eval "$home_manager_cmd $args 2>&1 | tee -a '$log_file'"; then
            echo
            echo -e "${GREEN}âœ“${NC} Home-manager switch ${GREEN}completed successfully${NC}!"
            if [[ "$QUIET" != "true" ]]; then
                echo
                echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "  ${GREEN}âœ¨ All done!${NC}"
                echo -e "  Restart your shell for changes to take effect"
                echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            fi
            # Clean up log file on success
            rm -f "$log_file"
        else
            echo
            echo -e "${RED}âœ—${NC} Home-manager switch ${RED}failed${NC}!"
            echo
            echo -e "${YELLOW}To debug:${NC}"
            echo -e "  ${BLUE}â†’${NC} less '$log_file'"
            exit 1
        fi
    fi
}

# Run main function
main "$@"